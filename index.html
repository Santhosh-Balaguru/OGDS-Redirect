<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Auth Redirect</title>
</head>
<body>
  <h2 id="header">Authenticating…</h2>
  <p id="status">Redirecting back to Obsidian</p>
  <script>
    function getParam(name) {
      return new URL(location.href).searchParams.get(name);
    }

    const code = getParam('code');
    const state = getParam('state');

    console.log('[Redirect Page] Loaded');
    console.log('[Redirect Page] URL code param:', code);
    console.log('[Redirect Page] URL state param:', state);

    if (code && state) {
      document.getElementById('header').textContent = 'Authentication Successful!';
      document.getElementById('status').textContent = 'Returning code to Obsidian…';

      try {
        const channel = new BroadcastChannel('obsidian-auth');
        channel.postMessage({ code, state });
        console.log('[Redirect Page] Code sent via BroadcastChannel');
        setTimeout(() => window.close(), 500);
      } catch (e) {
        console.error('[Redirect Page] BroadcastChannel failed', e);
        document.getElementById('header').textContent = 'Error sending code.';
        document.getElementById('status').textContent = 'Please return to Obsidian and try again.';
      }
    } else {
      console.error('[Redirect Page] Missing code or state');
    }
  </script>
</body>
</html>
